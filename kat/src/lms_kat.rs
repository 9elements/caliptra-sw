/*++

Licensed under the Apache-2.0 license.

File Name:

    lms_kat.rs

Abstract:

    File contains the Known Answer Tests (KAT) for LMS cryptography operations.

--*/

use crate::caliptra_err_def;
use caliptra_drivers::{
    CaliptraResult, HashValue, LmotsAlgorithmType, LmotsSignature, Lms, LmsAlgorithmType,
    LmsIdentifier, LmsSignature,
};

caliptra_err_def! {
    LmsKat,
    LmsKatErr
    {
        DigestFailure = 0x01,
        DigestMismatch = 0x2,
    }
}

#[derive(Default, Debug)]
pub struct LmsKat {}

impl LmsKat {
    /// This function executes the Known Answer Tests (aka KAT) for LMS.
    pub fn execute(&self, lms: &Lms) -> CaliptraResult<()> {
        self.kat_lms_24(lms)
    }

    fn _kat_lms_24(&self, _lms: &Lms) -> CaliptraResult<()> {
        Ok(())
    }

    fn kat_lms_24(&self, lms: &Lms) -> CaliptraResult<()> {
        const MESSAGE: [u8; 16] = [
            110, 117, 109, 58, 32, 50, 55, 54, 55, 53, 53, 49, 51, 56, 52, 49,
        ];

        const LMS_TYPE: LmsAlgorithmType = LmsAlgorithmType::LmsSha256N24H15;
        const LMOTS_TYPE: LmotsAlgorithmType = LmotsAlgorithmType::LmotsSha256N24W4;
        const Q: u32 = 0;
        const LMS_IDENTIFIER: LmsIdentifier = [
            97, 165, 213, 125, 55, 245, 228, 107, 251, 117, 32, 128, 107, 7, 161, 184,
        ];
        const LMS_PUBLIC_KEY: HashValue<6> = HashValue([
            579540052, 1388281546, 2202323831, 3083495119, 1138789092, 984123730,
        ]);
        const NONCE: [u32; 6] = [0, 0, 0, 0, 0, 0];
        const Y: [HashValue<6>; 51] = [
            HashValue([
                478842288, 2037565579, 2901971799, 106044040, 933382300, 4108603979,
            ]),
            HashValue([
                3378227794, 1418116896, 3740356513, 1272654603, 802907796, 2929761208,
            ]),
            HashValue([
                459040623, 3900085619, 3851157366, 3587524843, 13772290, 1812680794,
            ]),
            HashValue([
                3303703146, 90840056, 4216379329, 2080868071, 3259256757, 2568740631,
            ]),
            HashValue([
                1715644319, 4200184388, 3864885839, 2664636181, 3824928872, 3804933635,
            ]),
            HashValue([
                284915646, 1740521888, 932208248, 1615610895, 473400982, 911066563,
            ]),
            HashValue([
                2460002339, 2377005565, 2588854967, 2545258917, 826272598, 3014863730,
            ]),
            HashValue([
                2617380722, 3867339702, 850656494, 3463268013, 196649542, 473651007,
            ]),
            HashValue([
                1568803873, 1405244747, 3631532005, 788323854, 371043052, 2101193023,
            ]),
            HashValue([
                1946739813, 412281995, 3247504055, 508716864, 395546714, 2740074595,
            ]),
            HashValue([
                265399871, 3912180207, 3179641956, 2907942765, 709185662, 826498776,
            ]),
            HashValue([
                1779970460, 2132580331, 3873626227, 1446554230, 2743685741, 1732707195,
            ]),
            HashValue([
                3085584247, 2473219232, 3816271872, 681151956, 629410897, 2285089718,
            ]),
            HashValue([
                2713906490, 272181505, 2982680735, 3763752411, 642274390, 2838859517,
            ]),
            HashValue([
                19635169, 3125876961, 2801778496, 3914024241, 2438416081, 262618832,
            ]),
            HashValue([
                4067171277, 2658108011, 4100835168, 1634304413, 1476940110, 3041994771,
            ]),
            HashValue([
                147973283, 4159928770, 4269832064, 3650397499, 213074198, 3382396102,
            ]),
            HashValue([
                812420042, 2263660467, 4172096749, 3684774620, 3752931902, 2601277638,
            ]),
            HashValue([
                3270311232, 1764568500, 4044307723, 2811294894, 1291040180, 4123135404,
            ]),
            HashValue([
                246663576, 85269484, 927964311, 1532477577, 3743165589, 221159323,
            ]),
            HashValue([
                2535013025, 1267113049, 4260279527, 1391649643, 920836892, 35223222,
            ]),
            HashValue([
                2004296784, 3361382608, 3290606120, 1407838209, 2460053234, 3358930762,
            ]),
            HashValue([
                2973844849, 1613672058, 2861124814, 571299062, 4050241340, 579999421,
            ]),
            HashValue([
                3329542884, 1783326549, 1324452681, 2551039076, 674187758, 303755361,
            ]),
            HashValue([
                2727530221, 2705266868, 2061094051, 1446454219, 2256568043, 3325559153,
            ]),
            HashValue([
                2998864659, 1614568967, 3624682721, 327251818, 1951244014, 48193139,
            ]),
            HashValue([
                2503283372, 639730319, 3988073566, 1785497660, 2971511726, 462987315,
            ]),
            HashValue([
                3463727488, 2334541384, 3332131135, 4197777294, 4023147797, 4070796932,
            ]),
            HashValue([
                514478523, 2554251602, 1461663296, 645948831, 2588543399, 3910486554,
            ]),
            HashValue([
                912760233, 2166264542, 2666527708, 3764067081, 124045159, 3375609283,
            ]),
            HashValue([
                4249406857, 2837733522, 3870659915, 4038448802, 244562630, 3595326015,
            ]),
            HashValue([
                2854109995, 2240742235, 3331011571, 2759664809, 3685623330, 4127798752,
            ]),
            HashValue([
                3540251388, 4021046826, 663928744, 2843134979, 4059126825, 4282849976,
            ]),
            HashValue([
                2626570816, 983700742, 602908409, 1133147355, 455260479, 1458644477,
            ]),
            HashValue([
                294633385, 1265618497, 808800971, 2329419888, 878280753, 2813595164,
            ]),
            HashValue([
                1846762283, 2702969143, 2485978482, 3680542002, 1048483557, 4100482906,
            ]),
            HashValue([
                583375217, 656167223, 2269813415, 1640700526, 1532348189, 2588972528,
            ]),
            HashValue([
                3119636975, 88131201, 1277844453, 4059334062, 1468573516, 357154165,
            ]),
            HashValue([
                3206772289, 2725416931, 2179649821, 3482125492, 1675704398, 736440213,
            ]),
            HashValue([
                1430845061, 1560731781, 3494755071, 3062802185, 2398556740, 1179614887,
            ]),
            HashValue([
                331327439, 2497219409, 2725347447, 63788544, 2030555391, 3024245492,
            ]),
            HashValue([
                1954814547, 1802326803, 3241422568, 4192488968, 2757454596, 1633440862,
            ]),
            HashValue([
                4182628695, 3496945494, 4211519697, 472823493, 4157316779, 3415802234,
            ]),
            HashValue([
                178314629, 2903036506, 37661035, 1646944333, 3099603181, 2076228121,
            ]),
            HashValue([
                1545425269, 4069319690, 4252021427, 3553800792, 4153480417, 2884734833,
            ]),
            HashValue([
                297955298, 1783653062, 4257788824, 2917704560, 889743350, 2032523895,
            ]),
            HashValue([
                491784669, 2279729208, 1359211246, 2331774111, 1655071710, 812053612,
            ]),
            HashValue([
                730450214, 1902251471, 2491676697, 3028557624, 1463929483, 1236914180,
            ]),
            HashValue([
                2418933936, 2013304429, 3669414731, 3655500543, 2261668846, 38897242,
            ]),
            HashValue([
                2421517872, 61208046, 2401927330, 93761399, 3165847949, 823894712,
            ]),
            HashValue([
                740571196, 160644418, 1614321894, 2422357461, 2817876798, 4003799705,
            ]),
        ];
        const PATH: [HashValue<6>; 15] = [
            HashValue([
                332013303, 2133305192, 1586890810, 2594858904, 749114288, 3800515121,
            ]),
            HashValue([
                43793274, 1411973314, 1929001310, 2467684319, 4247927388, 1326960696,
            ]),
            HashValue([
                3365850569, 730639146, 3680996437, 2749642967, 2947717154, 3067846547,
            ]),
            HashValue([
                2307750806, 3128361098, 962910908, 1353259373, 1437819285, 745905715,
            ]),
            HashValue([
                3002322814, 109086481, 3888960867, 880804395, 1452945052, 2913780650,
            ]),
            HashValue([
                1340836705, 2420511100, 4101792876, 1224780212, 3020269916, 3922414771,
            ]),
            HashValue([
                4169939739, 1101225900, 276124546, 2836206505, 1224358505, 2737518852,
            ]),
            HashValue([
                679483660, 1752086742, 3372635835, 1976435998, 3831988362, 926413576,
            ]),
            HashValue([
                1377054817, 3368744234, 1710106926, 4042420074, 483148615, 2762938448,
            ]),
            HashValue([
                3334340474, 1026598087, 2421587696, 194508422, 2177493805, 2311152814,
            ]),
            HashValue([
                2102547046, 1566257160, 2601338636, 3074997772, 3975248047, 3576002342,
            ]),
            HashValue([
                1940565810, 1948948198, 2659607687, 920583857, 3932817299, 2932055868,
            ]),
            HashValue([
                3824202042, 2567462268, 3180470269, 976729237, 2036797765, 3058933825,
            ]),
            HashValue([
                1544201135, 2643746384, 2844997193, 2491934633, 891981884, 233930999,
            ]),
            HashValue([
                108664043, 374382587, 727575830, 3003055160, 4067183468, 3435434694,
            ]),
        ];

        const OTS: LmotsSignature<6, 51> = LmotsSignature {
            ots_type: LMOTS_TYPE,
            nonce: NONCE,
            y: Y,
        };

        const LMS_SIG: LmsSignature<6, 51> = LmsSignature {
            q: Q,
            lmots_signature: OTS,
            sig_type: LMS_TYPE,
            lms_path: &PATH,
        };

        let success =
            lms.verify_lms_signature(&MESSAGE, &LMS_IDENTIFIER, Q, &LMS_PUBLIC_KEY, &LMS_SIG)?;
        if !success {
            raise_err!(DigestMismatch);
        }
        Ok(())
    }
}
