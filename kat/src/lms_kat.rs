/*++

Licensed under the Apache-2.0 license.

File Name:

    lms_kat.rs

Abstract:

    File contains the Known Answer Tests (KAT) for LMS cryptography operations.

--*/

use crate::caliptra_err_def;
use caliptra_drivers::{
    CaliptraResult, HashValue, LmotsAlgorithmType, LmotsSignature, Lms, LmsAlgorithmType,
    LmsIdentifier, LmsSignature,
};

caliptra_err_def! {
    LmsKat,
    LmsKatErr
    {
        DigestFailure = 0x01,
        DigestMismatch = 0x2,
    }
}

#[derive(Default, Debug)]
pub struct LmsKat {}

impl LmsKat {
    /// This function executes the Known Answer Tests (aka KAT) for LMS.
    pub fn execute(&self, lms: &Lms) -> CaliptraResult<()> {
        self.kat_lms_24(lms)
    }

    fn _kat_lms_24(&self, _lms: &Lms) -> CaliptraResult<()> {
        Ok(())
    }

    fn kat_lms_24(&self, lms: &Lms) -> CaliptraResult<()> {
        const MESSAGE: [u8; 8] = [0, 0, 22, 178, 60, 142, 64, 147];
        const LMS_TYPE: LmsAlgorithmType = LmsAlgorithmType::LmsSha256N24H15;
        const LMOTS_TYPE: LmotsAlgorithmType = LmotsAlgorithmType::LmotsSha256N24W4;
        const Q: u32 = 0;
        const LMS_IDENTIFIER: LmsIdentifier = [
            97, 165, 213, 125, 55, 245, 228, 107, 251, 117, 32, 128, 107, 7, 161, 184,
        ];
        const LMS_PUBLIC_KEY: HashValue<6> = HashValue([
            696094727, 1137557096, 1485581987, 2094784170, 2077863550, 3321315649,
        ]);
        const NONCE: [u32; 6] = [0, 0, 0, 0, 0, 0];
        const Y: [HashValue<6>; 51] = [
            HashValue([
                1284415681, 4165257503, 2675208215, 1584177052, 3924744145, 3434031041,
            ]),
            HashValue([
                585673589, 4161775892, 1909928180, 942680446, 3176931454, 454584104,
            ]),
            HashValue([
                4202046980, 2524319902, 2236298264, 2483673275, 807596404, 4288114730,
            ]),
            HashValue([
                120645963, 1443116440, 923842371, 3021155281, 261560086, 30891530,
            ]),
            HashValue([
                3205060249, 3799221443, 289498918, 2652117363, 2331804106, 1810155726,
            ]),
            HashValue([
                3328327270, 1473805112, 1619347480, 512510432, 3969105453, 2306121361,
            ]),
            HashValue([
                1788553660, 3529076383, 3567002930, 2481365705, 1368792271, 18409196,
            ]),
            HashValue([
                232026593, 4239407697, 3103649056, 496362581, 1783352431, 4291732638,
            ]),
            HashValue([
                961283696, 2427597519, 1675453828, 3195963919, 1076691231, 3511606142,
            ]),
            HashValue([
                3849011718, 2100283922, 2687419332, 601074423, 3933992961, 4183809881,
            ]),
            HashValue([
                711797647, 2925199047, 2092301076, 5447485, 2885931418, 4174979239,
            ]),
            HashValue([
                3623366179, 3966024884, 2184367187, 3859847436, 422540123, 3897941616,
            ]),
            HashValue([
                839846265, 2520922091, 2488008293, 799958596, 1918314415, 3945009209,
            ]),
            HashValue([
                734156648, 3204007329, 1398649124, 2044216708, 3647028801, 1873744986,
            ]),
            HashValue([
                949778034, 812356122, 2195103691, 1136328522, 3075711273, 3809092846,
            ]),
            HashValue([
                1062765823, 1514251529, 4004396020, 2345964076, 2674327586, 734072394,
            ]),
            HashValue([
                2876946590, 101953978, 314580517, 2568631103, 1591323606, 1590833493,
            ]),
            HashValue([
                3269170168, 3982856428, 3529706604, 3793100892, 1938720256, 371337483,
            ]),
            HashValue([
                1036968006, 3254607217, 3412051241, 1414218195, 1327386135, 1124184684,
            ]),
            HashValue([
                274816239, 1388589647, 1512703170, 1912234870, 1500590190, 1018976148,
            ]),
            HashValue([
                3307463763, 1672226688, 697277050, 2397899412, 2092059307, 1828107302,
            ]),
            HashValue([
                473500186, 3242141482, 712986329, 2980970739, 648810170, 183458413,
            ]),
            HashValue([
                3775711901, 3623943915, 2626941997, 1352946851, 1820963631, 187027742,
            ]),
            HashValue([
                1047742543, 115968366, 3738389234, 1412946409, 292194489, 2539002004,
            ]),
            HashValue([
                3505492468, 3385236230, 2313394471, 1052692434, 3161299137, 3961713869,
            ]),
            HashValue([
                1142289238, 1466271889, 3031389714, 3079595241, 3681489104, 4074598752,
            ]),
            HashValue([
                2147965447, 1768487281, 2123364511, 1132601470, 99394411, 1451874125,
            ]),
            HashValue([
                1157378347, 1978787860, 2125201980, 2099663825, 1888961336, 1787875337,
            ]),
            HashValue([
                1237871309, 3843793531, 838483463, 280033997, 719643122, 1230232035,
            ]),
            HashValue([
                664531978, 768615690, 3458703066, 706096543, 3958443080, 275982825,
            ]),
            HashValue([
                1942908456, 3449880004, 683286021, 2750356077, 1445974704, 168033445,
            ]),
            HashValue([
                4273783630, 2714609811, 3445933052, 2877996368, 2851214441, 16371380,
            ]),
            HashValue([
                3487329022, 2915392851, 93287840, 1166040825, 959971941, 234018812,
            ]),
            HashValue([
                2748140661, 820945647, 29101804, 4220966149, 3147764101, 4154988147,
            ]),
            HashValue([
                1651430362, 3480423766, 2670582778, 3821070428, 1314569974, 839970375,
            ]),
            HashValue([
                1163180596, 3138897473, 447633912, 1556460648, 1184716748, 4090081353,
            ]),
            HashValue([
                1631059434, 3695329594, 1347783219, 296633368, 3313336936, 4019433231,
            ]),
            HashValue([
                4232991624, 4211493283, 3861414216, 116883437, 1294785854, 3826574257,
            ]),
            HashValue([
                1588376856, 2061364919, 3470595629, 2778000804, 3222055885, 1722711074,
            ]),
            HashValue([
                1838838890, 1288918122, 3813755712, 3671680173, 2531307358, 3105335841,
            ]),
            HashValue([
                3286356692, 3319178016, 1303343516, 3555582856, 695912626, 2118953511,
            ]),
            HashValue([
                3261351807, 1861234829, 1742675002, 1706127647, 901051874, 4199042523,
            ]),
            HashValue([
                653224441, 2993034682, 1597399278, 2266611406, 1720714016, 2105851174,
            ]),
            HashValue([
                4150053651, 1868297981, 2723451237, 217109037, 952947213, 101241194,
            ]),
            HashValue([
                680682892, 1301520824, 3837653452, 903238848, 1501907539, 1055288269,
            ]),
            HashValue([
                783197566, 270191621, 1010590992, 450346452, 3424376718, 3415696698,
            ]),
            HashValue([
                1519267691, 839434533, 961506527, 3751718789, 1180599279, 3824203019,
            ]),
            HashValue([
                3641786281, 2183164873, 147307493, 479700087, 908433237, 3877089987,
            ]),
            HashValue([
                2970757168, 2820844037, 3764659462, 1159788092, 369204685, 3647582008,
            ]),
            HashValue([
                953966611, 360945066, 552847314, 2202387055, 2332299423, 1378521257,
            ]),
            HashValue([
                1108223833, 1619197672, 950579845, 2424660518, 2613678085, 3326755919,
            ]),
        ];
        const PATH: [HashValue<6>; 15] = [
            HashValue([
                1760934884, 1160974002, 1990238799, 267859481, 113751208, 3388149368,
            ]),
            HashValue([
                753654715, 2474093475, 4256467902, 3512463398, 1295833434, 1515419736,
            ]),
            HashValue([
                266456338, 2386078959, 585983611, 2468483732, 1500541410, 1742404032,
            ]),
            HashValue([
                687814646, 3532010149, 3699022277, 2016328311, 2991263866, 3973309061,
            ]),
            HashValue([
                2967860042, 2977253403, 3734267690, 906611830, 1288340027, 800551513,
            ]),
            HashValue([
                2943987719, 4233356000, 38386356, 3380840734, 3663927276, 3338314811,
            ]),
            HashValue([
                2047894530, 1302807197, 3255394108, 2087811365, 1736532268, 1211821865,
            ]),
            HashValue([
                3132394148, 1094650762, 712242208, 1354514809, 614475040, 4147663622,
            ]),
            HashValue([
                861016425, 3632352463, 534259954, 869387514, 1130937812, 2545832298,
            ]),
            HashValue([
                1845839279, 1184657641, 431903668, 3476888552, 2487374102, 3213724298,
            ]),
            HashValue([
                2323387875, 1909448394, 3706126354, 129755273, 1461073745, 3384086687,
            ]),
            HashValue([
                407224731, 1350250080, 3895044108, 673460336, 1362631865, 3793157936,
            ]),
            HashValue([
                1701857888, 626041185, 2149162399, 3812237433, 2768912796, 1845808428,
            ]),
            HashValue([
                3979117792, 516956055, 872110595, 4107899640, 3603655842, 708634112,
            ]),
            HashValue([
                3935898722, 3245155541, 1122548256, 2447607620, 2203434974, 2573656026,
            ]),
        ];
        const OTS: LmotsSignature<6, 51> = LmotsSignature {
            ots_type: LMOTS_TYPE,
            nonce: NONCE,
            y: Y,
        };

        const LMS_SIG: LmsSignature<6, 51> = LmsSignature {
            q: Q,
            lmots_signature: OTS,
            sig_type: LMS_TYPE,
            lms_path: &PATH,
        };

        let success =
            lms.verify_lms_signature(&MESSAGE, &LMS_IDENTIFIER, Q, &LMS_PUBLIC_KEY, &LMS_SIG)?;
        if !success {
            raise_err!(DigestMismatch);
        }
        Ok(())
    }
}
