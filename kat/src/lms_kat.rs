/*++

Licensed under the Apache-2.0 license.

File Name:

    lms_kat.rs

Abstract:

    File contains the Known Answer Tests (KAT) for LMS cryptography operations.

--*/

use crate::caliptra_err_def;
use caliptra_drivers::{
    CaliptraResult, HashValue, LmotsAlgorithmType, LmotsSignature, Lms, LmsAlgorithmType,
    LmsIdentifier, LmsSignature,
};

const MESSAGE: [u8; 33] = [
    116, 104, 105, 115, 32, 105, 115, 32, 116, 104, 101, 32, 109, 101, 115, 115, 97, 103, 101, 32,
    73, 32, 119, 97, 110, 116, 32, 115, 105, 103, 110, 101, 100,
];
const LMS_IDENTIFIER: LmsIdentifier = [
    145, 194, 114, 194, 201, 97, 85, 251, 155, 22, 228, 102, 15, 24, 243, 194,
];
const PUBLIC_HASH: HashValue<24> = HashValue([
    122, 74, 20, 116, 13, 207, 194, 205, 211, 40, 140, 241, 104, 23, 35, 64, 240, 120, 104, 120,
    243, 38, 69, 29,
]);
const LMS_TYPE: LmsAlgorithmType = LmsAlgorithmType::LmsSha256N24H15;
const LMOTS_TYPE: LmotsAlgorithmType = LmotsAlgorithmType::LmotsSha256N24W4;
const Q: u32 = 0;
const NONCE: [u8; 24] = [
    178, 205, 20, 29, 19, 163, 3, 249, 93, 131, 185, 102, 172, 17, 127, 16, 30, 79, 171, 224, 234,
    202, 99, 34,
];
const Y: [HashValue<24>; 51] = [
    HashValue([
        72, 21, 192, 24, 188, 226, 206, 6, 48, 79, 183, 201, 236, 158, 53, 175, 7, 175, 200, 221,
        133, 66, 96, 185,
    ]),
    HashValue([
        139, 81, 98, 125, 246, 173, 42, 63, 133, 45, 44, 154, 67, 15, 12, 159, 70, 140, 90, 216,
        66, 30, 182, 224,
    ]),
    HashValue([
        50, 77, 99, 204, 201, 110, 185, 149, 231, 188, 114, 200, 235, 53, 4, 100, 41, 15, 169, 25,
        240, 89, 181, 76,
    ]),
    HashValue([
        40, 72, 226, 205, 30, 78, 12, 150, 103, 209, 175, 25, 238, 98, 252, 134, 185, 208, 111,
        122, 201, 138, 39, 112,
    ]),
    HashValue([
        9, 107, 55, 192, 57, 75, 215, 211, 220, 34, 255, 59, 235, 149, 176, 0, 153, 109, 132, 14,
        56, 0, 50, 109,
    ]),
    HashValue([
        164, 138, 6, 77, 12, 86, 234, 157, 163, 239, 143, 210, 102, 68, 188, 0, 221, 191, 14, 86,
        79, 194, 113, 225,
    ]),
    HashValue([
        61, 114, 38, 2, 2, 163, 238, 217, 177, 50, 235, 87, 90, 144, 176, 228, 183, 196, 218, 131,
        215, 233, 97, 224,
    ]),
    HashValue([
        236, 114, 70, 118, 209, 108, 76, 173, 52, 175, 181, 47, 77, 154, 15, 7, 207, 171, 198, 137,
        111, 163, 43, 19,
    ]),
    HashValue([
        152, 161, 91, 172, 87, 200, 134, 222, 49, 5, 22, 88, 192, 184, 228, 16, 194, 125, 209, 181,
        163, 33, 162, 159,
    ]),
    HashValue([
        99, 100, 188, 99, 207, 55, 206, 134, 79, 239, 168, 133, 152, 224, 175, 213, 211, 96, 47,
        185, 218, 149, 21, 198,
    ]),
    HashValue([
        242, 128, 205, 5, 29, 77, 255, 89, 47, 187, 141, 251, 167, 157, 100, 37, 168, 95, 57, 71,
        157, 76, 145, 237,
    ]),
    HashValue([
        213, 7, 138, 16, 216, 236, 104, 223, 18, 255, 85, 201, 62, 91, 53, 7, 124, 23, 250, 30,
        168, 134, 227, 79,
    ]),
    HashValue([
        224, 35, 121, 96, 20, 142, 135, 128, 24, 34, 98, 138, 110, 155, 219, 33, 27, 164, 242, 200,
        13, 103, 247, 134,
    ]),
    HashValue([
        133, 32, 164, 210, 110, 195, 218, 203, 225, 79, 234, 110, 151, 89, 38, 206, 177, 5, 123,
        229, 50, 36, 233, 201,
    ]),
    HashValue([
        212, 233, 134, 210, 191, 119, 166, 182, 51, 150, 189, 49, 21, 181, 195, 98, 216, 7, 204,
        239, 136, 71, 121, 41,
    ]),
    HashValue([
        167, 177, 8, 75, 27, 149, 19, 244, 231, 239, 254, 138, 127, 62, 110, 176, 203, 98, 170,
        145, 213, 158, 137, 53,
    ]),
    HashValue([
        160, 10, 81, 244, 220, 173, 168, 21, 8, 122, 110, 51, 53, 251, 151, 162, 194, 70, 7, 192,
        104, 121, 137, 0,
    ]),
    HashValue([
        182, 164, 182, 3, 14, 157, 32, 55, 129, 165, 202, 240, 47, 191, 183, 31, 166, 90, 187, 137,
        109, 10, 232, 194,
    ]),
    HashValue([
        147, 144, 227, 108, 96, 90, 223, 216, 62, 27, 77, 220, 242, 126, 20, 25, 159, 241, 92, 110,
        109, 175, 98, 26,
    ]),
    HashValue([
        53, 151, 168, 255, 153, 30, 243, 202, 74, 187, 175, 170, 28, 8, 241, 95, 5, 176, 66, 87,
        16, 105, 148, 84,
    ]),
    HashValue([
        13, 181, 212, 35, 154, 213, 160, 37, 230, 16, 176, 251, 204, 187, 13, 91, 52, 100, 216,
        171, 104, 61, 149, 138,
    ]),
    HashValue([
        29, 1, 176, 122, 190, 250, 48, 151, 99, 235, 115, 68, 176, 147, 149, 253, 40, 158, 49, 230,
        214, 178, 138, 48,
    ]),
    HashValue([
        42, 188, 210, 7, 222, 203, 73, 95, 144, 237, 83, 69, 92, 60, 132, 41, 104, 113, 172, 97,
        244, 62, 182, 174,
    ]),
    HashValue([
        178, 241, 159, 158, 169, 108, 82, 252, 117, 90, 95, 36, 74, 147, 103, 215, 219, 217, 183,
        184, 132, 208, 86, 55,
    ]),
    HashValue([
        237, 157, 93, 145, 139, 250, 215, 55, 214, 188, 130, 233, 179, 20, 138, 132, 243, 115, 134,
        17, 114, 117, 188, 183,
    ]),
    HashValue([
        89, 12, 93, 242, 143, 21, 156, 185, 58, 197, 52, 78, 222, 18, 175, 243, 6, 177, 149, 224,
        46, 91, 105, 129,
    ]),
    HashValue([
        91, 84, 40, 63, 89, 71, 179, 180, 223, 241, 189, 142, 127, 152, 231, 170, 211, 252, 31,
        101, 61, 59, 185, 16,
    ]),
    HashValue([
        251, 111, 252, 42, 89, 31, 3, 128, 8, 61, 110, 249, 247, 173, 228, 189, 21, 204, 33, 23,
        106, 62, 168, 168,
    ]),
    HashValue([
        20, 154, 147, 225, 115, 61, 197, 6, 121, 16, 249, 178, 254, 9, 153, 108, 155, 231, 52, 0,
        140, 250, 95, 0,
    ]),
    HashValue([
        218, 77, 220, 97, 108, 169, 89, 222, 38, 56, 198, 235, 128, 56, 125, 211, 131, 198, 7, 92,
        204, 175, 136, 151,
    ]),
    HashValue([
        4, 14, 233, 195, 160, 30, 22, 40, 19, 30, 179, 42, 66, 198, 185, 140, 55, 112, 95, 156,
        100, 55, 150, 126,
    ]),
    HashValue([
        236, 127, 95, 84, 140, 249, 77, 122, 7, 106, 152, 79, 138, 26, 43, 162, 213, 7, 228, 62,
        154, 16, 21, 89,
    ]),
    HashValue([
        0, 23, 197, 175, 177, 98, 95, 228, 215, 206, 101, 149, 24, 233, 155, 73, 168, 162, 28, 186,
        124, 191, 83, 100,
    ]),
    HashValue([
        200, 86, 142, 45, 192, 246, 202, 185, 9, 4, 47, 114, 43, 138, 84, 189, 101, 6, 237, 51, 91,
        145, 15, 137,
    ]),
    HashValue([
        70, 183, 53, 0, 155, 153, 37, 108, 93, 252, 242, 36, 35, 218, 246, 4, 98, 67, 120, 169,
        202, 34, 140, 6,
    ]),
    HashValue([
        200, 49, 160, 11, 56, 253, 217, 249, 33, 241, 103, 104, 73, 237, 95, 117, 150, 136, 175,
        99, 240, 134, 156, 1,
    ]),
    HashValue([
        229, 108, 45, 64, 227, 161, 134, 139, 241, 29, 60, 32, 140, 239, 22, 106, 219, 119, 202,
        195, 24, 130, 211, 172,
    ]),
    HashValue([
        227, 86, 199, 250, 154, 147, 253, 239, 49, 65, 70, 60, 175, 53, 137, 16, 67, 237, 49, 169,
        207, 96, 1, 40,
    ]),
    HashValue([
        222, 82, 255, 235, 172, 22, 28, 115, 69, 151, 178, 131, 152, 19, 231, 181, 53, 210, 168,
        67, 191, 3, 38, 40,
    ]),
    HashValue([
        159, 25, 0, 1, 149, 32, 135, 56, 72, 179, 107, 34, 241, 106, 130, 119, 244, 71, 212, 253,
        143, 81, 138, 167,
    ]),
    HashValue([
        116, 39, 42, 63, 111, 174, 216, 155, 182, 149, 32, 250, 204, 91, 151, 121, 133, 19, 108,
        48, 2, 169, 153, 142,
    ]),
    HashValue([
        80, 166, 240, 110, 46, 210, 228, 75, 247, 41, 168, 186, 54, 74, 156, 230, 86, 116, 18, 71,
        223, 11, 2, 32,
    ]),
    HashValue([
        41, 196, 199, 163, 74, 94, 239, 23, 232, 99, 102, 216, 253, 71, 52, 158, 157, 239, 26, 102,
        190, 32, 212, 180,
    ]),
    HashValue([
        139, 57, 122, 46, 178, 187, 68, 63, 144, 27, 208, 216, 81, 144, 141, 126, 18, 181, 63, 119,
        62, 30, 124, 198,
    ]),
    HashValue([
        39, 151, 241, 251, 1, 194, 157, 67, 85, 169, 217, 207, 53, 38, 241, 236, 211, 23, 166, 47,
        39, 60, 235, 118,
    ]),
    HashValue([
        123, 230, 224, 127, 133, 208, 58, 108, 132, 159, 226, 140, 211, 57, 60, 67, 85, 254, 123,
        75, 204, 211, 159, 218,
    ]),
    HashValue([
        49, 38, 201, 56, 57, 239, 189, 1, 204, 252, 149, 48, 62, 85, 153, 45, 120, 222, 224, 21,
        163, 165, 89, 18,
    ]),
    HashValue([
        168, 149, 40, 154, 175, 156, 17, 68, 71, 175, 82, 121, 216, 140, 127, 151, 138, 163, 212,
        38, 210, 186, 142, 24,
    ]),
    HashValue([
        235, 254, 12, 129, 114, 245, 65, 216, 146, 165, 0, 15, 174, 2, 138, 156, 40, 232, 63, 65,
        184, 216, 49, 42,
    ]),
    HashValue([
        67, 136, 144, 81, 38, 102, 146, 175, 247, 18, 146, 76, 113, 100, 168, 78, 114, 121, 236,
        122, 24, 219, 56, 242,
    ]),
    HashValue([
        102, 124, 68, 54, 213, 227, 203, 243, 113, 88, 239, 251, 10, 128, 10, 45, 75, 152, 230,
        207, 90, 121, 238, 214,
    ]),
];
const PATH: [HashValue<24>; 15] = [
    HashValue([
        239, 4, 12, 91, 9, 158, 67, 234, 35, 103, 72, 20, 204, 85, 46, 99, 131, 134, 184, 55, 197,
        105, 229, 139,
    ]),
    HashValue([
        85, 199, 72, 106, 30, 210, 183, 13, 97, 57, 164, 227, 237, 239, 92, 88, 59, 27, 115, 114,
        246, 168, 124, 124,
    ]),
    HashValue([
        209, 200, 183, 29, 18, 45, 5, 214, 150, 144, 14, 104, 221, 33, 200, 108, 108, 140, 18, 186,
        37, 161, 148, 8,
    ]),
    HashValue([
        225, 2, 44, 30, 209, 109, 47, 37, 88, 0, 101, 6, 61, 70, 35, 44, 239, 167, 218, 217, 41,
        31, 198, 172,
    ]),
    HashValue([
        129, 49, 255, 104, 94, 79, 11, 67, 170, 4, 205, 235, 102, 202, 107, 122, 16, 108, 99, 183,
        211, 193, 228, 7,
    ]),
    HashValue([
        158, 181, 76, 78, 174, 102, 40, 42, 120, 218, 191, 35, 125, 203, 191, 218, 135, 246, 65,
        247, 93, 38, 142, 41,
    ]),
    HashValue([
        105, 205, 183, 161, 241, 224, 97, 18, 131, 159, 181, 61, 11, 5, 65, 248, 177, 161, 122,
        209, 239, 128, 192, 42,
    ]),
    HashValue([
        217, 33, 223, 254, 178, 138, 49, 128, 13, 85, 22, 156, 8, 20, 210, 237, 80, 19, 205, 169,
        40, 202, 137, 128,
    ]),
    HashValue([
        175, 218, 132, 103, 72, 142, 198, 94, 225, 160, 175, 85, 150, 231, 151, 92, 234, 5, 218,
        32, 94, 63, 27, 9,
    ]),
    HashValue([
        66, 156, 125, 182, 23, 142, 175, 114, 246, 85, 204, 238, 141, 52, 240, 114, 70, 211, 203,
        233, 72, 187, 203, 208,
    ]),
    HashValue([
        141, 25, 13, 141, 195, 116, 0, 6, 42, 88, 208, 184, 215, 100, 54, 86, 251, 67, 234, 149,
        233, 126, 162, 220,
    ]),
    HashValue([
        99, 220, 174, 138, 47, 202, 70, 26, 227, 113, 122, 151, 90, 71, 233, 220, 234, 166, 110,
        203, 200, 75, 150, 156,
    ]),
    HashValue([
        180, 111, 126, 96, 146, 175, 152, 231, 223, 62, 83, 96, 58, 193, 31, 215, 108, 97, 4, 140,
        188, 213, 201, 93,
    ]),
    HashValue([
        68, 224, 74, 27, 158, 132, 36, 12, 228, 76, 153, 192, 195, 128, 136, 88, 123, 246, 188,
        184, 190, 72, 210, 233,
    ]),
    HashValue([
        234, 197, 152, 5, 192, 141, 50, 237, 15, 159, 122, 105, 236, 92, 92, 221, 94, 139, 187,
        231, 58, 80, 19, 98,
    ]),
];

const LMOTS_SIGNATURE: LmotsSignature<24, 51> = LmotsSignature {
    ots_type: LMOTS_TYPE,
    nonce: NONCE,
    y: Y,
};

const LMS_SIG: LmsSignature<24, 51> = LmsSignature {
    q: Q,
    lmots_signature: LMOTS_SIGNATURE,
    sig_type: LMS_TYPE,
    lms_path: &PATH,
};

caliptra_err_def! {
    LmsKat,
    LmsKatErr
    {
        DigestFailure = 0x01,
        DigestMismatch = 0x2,
    }
}

#[derive(Default, Debug)]
pub struct LmsKat {}

impl LmsKat {
    /// This function executes the Known Answer Tests (aka KAT) for LMS.
    pub fn execute(&self, lms: &Lms) -> CaliptraResult<()> {
        self.kat_lms_24(lms)
    }

    fn _kat_lms_24(&self, _lms: &Lms) -> CaliptraResult<()> {
        Ok(())
    }

    fn kat_lms_24(&self, lms: &Lms) -> CaliptraResult<()> {
        let success = lms
            .verify_lms_signature(15, &MESSAGE, &LMS_IDENTIFIER, Q, &PUBLIC_HASH, &LMS_SIG)
            .unwrap();
        if !success {
            raise_err!(DigestMismatch);
        }
        Ok(())
    }
}
